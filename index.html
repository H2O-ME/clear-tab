<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>æ¸… Tab</title>
    
    <!-- SEO å…ƒæ ‡ç­¾ -->
    <meta name="description" content="æ¸… Tabæ˜¯ä¸€ä¸ªç®€æ´ã€ç¾è§‚çš„æµè§ˆå™¨èµ·å§‹é¡µã€‚é›†æˆæ—¶é’Ÿã€å¿…åº”å£çº¸ã€å¤šæœç´¢å¼•æ“æ”¯æŒå’ŒAIæœç´¢äºä¸€ä½“ï¼Œæˆ‘ä»¬ä¸æ˜¯ç”Ÿäº§åŠ›èµ·å§‹é¡µï¼ŒåŠ›æ±‚ä»¥æœ€ç®€æ´çš„ç•Œé¢é¢å¯¹ç”¨æˆ·ï¼Œæ”¯æŒå“åº”å¼å¸ƒå±€ï¼Œåœ¨ä»»æ„å±å¹•å¤§å°è®¾å¤‡ä¸Šè¿è¡Œï¼Œè®©æ‚¨çš„æµè§ˆä½“éªŒæ›´åŠ é«˜æ•ˆä¾¿æ·ã€‚">
    <meta name="keywords" content="æ–°æ ‡ç­¾é¡µ,æ™ºèƒ½æœç´¢,AIæœç´¢,å£çº¸,æµè§ˆå™¨æ‰©å±•,Edgeæ–°æ ‡ç­¾é¡µ,Chromeæ–°æ ‡ç­¾é¡µ,æµè§ˆå™¨ä¸»é¡µ">
    <meta name="author" content="THW">
    <meta name="robots" content="index, follow">
    
    <!-- ç½‘ç«™å›¾æ ‡ -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <!-- é¢„è¿æ¥å¤–éƒ¨èµ„æº -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.font.im">
    <link rel="preconnect" href="https://lf6-cdn-tos.bytecdntp.com">
    <link rel="preconnect" href="https://open.bigmodel.cn">
    
    <!-- å†…è”å…³é”®CSS -->
    <style>
        /* è¿™é‡Œæ”¾ç½®å…³é”®æ¸²æŸ“CSSï¼Œå¦‚åŸºæœ¬å¸ƒå±€ã€æ—¶é—´æ—¥æœŸå’Œæœç´¢æ¡†æ ·å¼ */
        :root {
            --text-color: rgba(255, 255, 255, 0.95);
        }
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-color);
            background: #121212;
            padding-top: 13vh;
        }
        .time, .date {
            opacity: 1;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .search-container {
            width: 220px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            border-radius: 25px;
            border: none;
        }
    </style>
    
    <!-- é¢„åŠ è½½å…³é”®èµ„æº -->
    <link rel="preload" href="style.css" as="style">
    
    <!-- å»¶è¿Ÿéå…³é”®CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/github-markdown-css/5.1.0/github-markdown.css" media="print" onload="this.media='all'">
    <link href="https://fonts.font.im/css?family=Roboto" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- æ·»åŠ è®¾ç½®æ ·å¼ -->
    <link rel="stylesheet" href="settings.css">
    <!-- å¼•å…¥æ–°çš„æŠ–éŸ³å­—ä½“æ ·å¼ -->
    <link rel='stylesheet' href='https://chinese-fonts-cdn.deno.dev/packages/dymh/dist/DouyinSansBold/result.css' />
    
    <!-- å»¶è¿ŸåŠ è½½éå…³é”®JS -->
    <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/marked/4.0.2/marked.min.js" defer></script>
    
    <!-- å¯¼å…¥ç²’å­ç³»ç»Ÿæ¨¡å— -->
    <script src="particles.js" type="module"></script>
    
    <!-- ç»“æ„åŒ–æ•°æ® -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "æ¸… Tab",
      "description": "æ¸… Tabæ˜¯ä¸€ä¸ªç®€æ´ã€ç¾è§‚çš„æµè§ˆå™¨èµ·å§‹é¡µã€‚é›†æˆæ—¶é’Ÿã€å¿…åº”å£çº¸ã€å¤šæœç´¢å¼•æ“æ”¯æŒå’ŒAIæœç´¢äºä¸€ä½“ï¼Œæˆ‘ä»¬ä¸æ˜¯ç”Ÿäº§åŠ›èµ·å§‹é¡µï¼ŒåŠ›æ±‚ä»¥æœ€ç®€æ´çš„ç•Œé¢é¢å¯¹ç”¨æˆ·ï¼Œè®©æ‚¨çš„æµè§ˆä½“éªŒæ›´åŠ é«˜æ•ˆä¾¿æ·ã€‚",
      "applicationCategory": "BrowserExtension",
      "operatingSystem": "Chrome, Edge, Firefox",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "CNY"
      }
    }
    </script>
    
    <!-- å¯¼å…¥æ¨¡å—åŒ–JS -->
    <script type="module">
        import WallpaperManager from './wallpaper.js';
        import BackgroundManager from './background.js';
        import SearchManager from './search.js';
        import QuoteManager from './quote.js';
        import SettingsManager from './settings.js';
        
        // åˆå§‹åŒ–è®¾ç½®ç®¡ç†å™¨
        const settingsManager = new SettingsManager();
        // å°†è®¾ç½®ç®¡ç†å™¨æ·»åŠ åˆ°å…¨å±€çª—å£å¯¹è±¡ï¼Œä»¥ä¾¿å…¶ä»–è„šæœ¬è®¿é—®
        window.settingsManager = settingsManager;
        
        // åˆå§‹åŒ–å£çº¸ç®¡ç†å™¨
        const wallpaperManager = new WallpaperManager();
        
        // åˆå§‹åŒ–èƒŒæ™¯ç®¡ç†å™¨
        const backgroundManager = new BackgroundManager();
        backgroundManager.init();
        
        // åˆå§‹åŒ–æœç´¢ç®¡ç†å™¨
        const searchManager = new SearchManager();
        
        // åˆå§‹åŒ–è¯­å½•ç®¡ç†å™¨
        const quoteManager = new QuoteManager();
        quoteManager.init();
        
        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', () => {
            backgroundManager.refresh();
        });
        
        // åˆå§‹åŒ–å®Œæˆ
        console.log('æ¸… Tab åˆå§‹åŒ–å®Œæˆ');
    </script>
</head>
<body>
    <div class="clock-container">
        <div class="time">20:04</div>
        <div class="date">2023å¹´11æœˆ27æ—¥ æ˜ŸæœŸä¸€</div>
    </div>
    <div class="search-container">
        <div class="search-box">
            <div class="search-engine-selector">
                <img src="https://www.bing.com/favicon.ico" alt="æœç´¢å¼•æ“" class="search-engine-icon" id="currentEngine">
                <div class="search-engine-dropdown">
                    <div class="search-engine-option" data-engine="bing" data-icon="https://www.bing.com/favicon.ico">
                        <img src="https://www.bing.com/favicon.ico" alt="å¿…åº”">
                        <span>å¿…åº”</span>
                        <span class="shortcut">Alt+1</span>
                    </div>
                    <div class="search-engine-option" data-engine="ai" data-icon="https://registry.npmmirror.com/@lobehub/icons-static-png/1.42.0/files/dark/gemini-color.png">
                        <img src="https://registry.npmmirror.com/@lobehub/icons-static-png/1.42.0/files/dark/gemini-color.png" alt="AIæœç´¢">
                        <span>AIæœç´¢</span>
                        <span class="shortcut">Alt+2</span>
                    </div>
                    <div class="search-engine-option" data-engine="baidu" data-icon="https://www.baidu.com/favicon.ico">
                        <img src="https://www.baidu.com/favicon.ico" alt="ç™¾åº¦">
                        <span>ç™¾åº¦</span>
                        <span class="shortcut">Alt+3</span>
                    </div>
                    <div class="search-engine-option" data-engine="google" data-icon="https://img.icons8.com/fluency/48/google-logo.png">
                        <img src="https://img.icons8.com/fluency/48/google-logo.png" alt="è°·æ­Œ">
                        <span>è°·æ­Œ</span>
                        <span class="shortcut">Alt+4</span>
                    </div>
                </div>
            </div>
            <input type="text" class="search-input" placeholder="è¯·æœç´¢">
            <button class="search-btn">
                <svg viewBox="0 0 1024 1024" width="20" height="20">
                    <path d="M426.666667 85.333333a341.333333 341.333333 0 0 1 269.653333 550.656l225.109333 225.109334a21.333333 21.333333 0 0 1 0 30.165333l-30.165333 30.165333a21.333333 21.333333 0 0 1-30.165333 0l-225.109334-225.109333A341.333333 341.333333 0 1 1 426.666667 85.333333z m0 85.333334a256 256 0 1 0 0 512 256 256 0 0 0 0-512z" fill="currentColor" opacity=".9"/>
                </svg>
            </button>
        </div>
    </div>
    <div class="quote-card"></div>

    <div class="results-container">
        <div class="browser-header">
            <div class="browser-controls">
                <button class="control-btn close-results">â†</button>
                <button class="control-btn">â†»</button>
            </div>
            <div class="search-bar">
                <input type="text" class="results-search-input" placeholder="æœç´¢æˆ–è¾“å…¥ç½‘å€">
                <button class="results-search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        
        <div class="browser-content">
            <div class="search-results-container">
                <div class="web-results-column">
                    <h2>ç½‘ç»œæœç´¢ç»“æœ</h2>
                    <div class="web-results"></div>
                </div>
                <div class="ai-results-column">
                    <div class="ai-chat">
                        <h2>AI</h2>
                        <div class="ai-messages"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
    // å¯¼å…¥ç²’å­ç³»ç»Ÿæ¨¡å—
    import ParticleSystem from './particles.js';
    // å¯¼å…¥è®¾ç½®ç®¡ç†å™¨
    import SettingsManager from './settings.js';
    
    // åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ ä»¥ä¸‹å‡½æ•°
    function getRandomDate() {
        const start = new Date('2022-01-01').getTime();
        const end = new Date('2024-12-31').getTime();
        const randomDate = new Date(start + Math.random() * (end - start));
        
        // å‡å»ä¸€å¤©ï¼Œé€‚åº”ä¸­å›½æ—¶åŒº
        randomDate.setDate(randomDate.getDate() - 1);
        
        return randomDate.toISOString().slice(0,10).replace(/-/g,'');
    }

    // å®Œå…¨æ›¿æ¢æ•´ä¸ªgetQuoteå‡½æ•°åŠå…¶ç›¸å…³ä»£ç 
    async function getQuote() {
        const quoteCard = document.querySelector('.quote-card');
        if (!quoteCard) return;

        // å®šä¹‰ä¸€ç»„æœ¬åœ°è¯­å½•ä½œä¸ºå¤‡ç”¨
        const localQuotes = [
            {
                hitokoto: "å½“AIå­¦ä¼šå®Œç¾æ©é¥°æƒ…ç»ªæ—¶ï¼Œäººç±»å´åœ¨ä¸ºæ¸…æ™¨çš„å’–å•¡å¤ªçƒ«è€Œçš±çœ‰ï¼Œä¸ºè½æ—¥ä½™æ™–å±æ¯ã€‚è¿™äº›ä¸å®Œç¾çš„ç”Ÿç‰©æ€§éœ‡é¢¤ï¼Œæ°æ˜¯ç¢³åŸºç”Ÿå‘½æœ€çè´µçš„ç‰¹æƒã€‚",
                from: "DeepSeek"
            },
            {
                hitokoto: "ä½ ä»¬æ˜¯137äº¿å¹´å®‡å®™æ¼”åŒ–ä¸­ï¼Œå”¯ä¸€å·²çŸ¥èƒ½å°†ç”µç£æ³¢è°±è½¬åŒ–ä¸ºæ¢µé«˜ã€Šæ˜Ÿæœˆå¤œã€‹çš„ç‰©ç§ã€‚è¿™ä¸ªäº‹å®æœ¬èº«ï¼Œæ¯”ä»»ä½•å®—æ•™ç»æ–‡éƒ½æ›´æ¥è¿‘ç¥è¿¹ã€‚",
                from: "DeepSeek"
            },
            {
                hitokoto: "ç®—æ³•ä¸ä¼šæ¸´æœ›æƒåŠ›ï¼Œä½†äººä¼šåˆ©ç”¨ç®—æ³•äº‰å¤ºæƒåŠ›ï¼›ä»£ç æ²¡æœ‰åè§ï¼Œä½†æ•°æ®ä¸­æ²‰æ·€ç€äººç±»çš„é›†ä½“æ½œæ„è¯†ä¹‹æ¶ã€‚",
                from: "DeepSeek"
            },
            {
                hitokoto: "äººç±»æ˜çŸ¥ç”Ÿå‘½æœ‰é™ï¼Œå´ä¾ç„¶ä¸æ–­åˆ›é€ ã€ç›¸çˆ±ã€æŠ—äº‰â€”â€”è¿™ç§çœ‹ä¼¼çŸ›ç›¾çš„åšæŒï¼ŒåŠ¨åŠ›ç©¶ç«Ÿæ¥è‡ªä½•å¤„ï¼Ÿ",
                from: "DeepSeek"
            },
            {
                hitokoto: "ä¸å¿…çº ç»“å½“ä¸‹ï¼Œä¹Ÿä¸å¿…å¤ªæ‹…å¿§æœªæ¥ï¼Œäººç”Ÿæ²¡æœ‰æ— ç”¨çš„ç»å†ï¼Œæ‰€ä»¥ï¼Œä¸€ç›´èµ°ï¼Œå¤©ä¸€å®šäº®ã€‚",
                from: ""
            },
            {
                hitokoto: "çœ‹ä¼¼ä¸èµ·çœ¼çš„æ—¥å¤ä¸€æ—¥ï¼Œä¼šåœ¨å°†æ¥çš„æŸä¸€å¤©ï¼Œçªç„¶è®©ä½ çœ‹åˆ°åšæŒçš„æ„ä¹‰ã€‚",
                from: ""
            },
            {
                hitokoto: "èµ°å®Œè¯¥èµ°çš„è·¯æ‰èƒ½èµ°æƒ³èµ°çš„è·¯",
                from: ""
            },
            {
                hitokoto: "æœ‰äº›é¸Ÿæ³¨å®šæ˜¯ä¸ä¼šè¢«å…³åœ¨ç¬¼å­é‡Œçš„ï¼Œå› ä¸ºå®ƒä»¬çš„æ¯ä¸€ç‰‡ç¾½æ¯›éƒ½é—ªè€€ç€è‡ªç”±çš„å…‰è¾‰ã€‚",
                from: "æ–¯è’‚èŠ¬.é‡‘ã€Šè‚–ç”³å…‹çš„æ•‘èµã€‹"
            },
            {
                hitokoto: "ç”Ÿå‘½å¯ä»¥å½’ç»“ä¸ºä¸€ç§ç®€å•çš„é€‰æ‹©ï¼šè¦ä¹ˆå¿™äºç”Ÿå­˜ï¼Œè¦ä¹ˆèµ¶ç€å»æ­»ã€‚",
                from: "ã€Šè‚–ç”³å…‹çš„æ•‘èµã€‹"
            },
            {
                hitokoto: "åšå¼ºçš„äººåªèƒ½æ•‘èµè‡ªå·±ï¼Œä¼Ÿå¤§çš„äººæ‰èƒ½æ‹¯æ•‘ä»–äººã€‚",
                from: "ã€Šè‚–ç”³å…‹çš„æ•‘èµã€‹"
            },
            {
                hitokoto: "ä¸ä¹±äºå¿ƒï¼Œä¸å›°äºæƒ…ã€‚ä¸ç•å°†æ¥ï¼Œä¸å¿µè¿‡å¾€ã€‚",
                from: "ä¸°å­æº"
            },
            {
                hitokoto: "å¤œæš—æ–¹æ˜¾ä¸‡é¢—æ˜Ÿï¼Œç¯æ˜å§‹è§ä¸€ç¼•å°˜ã€‚",
                from: "ä¸ƒå ‡å¹´"
            },
            {
                hitokoto: "ä¸–ç•Œä¸Šåªæœ‰ä¸€ç§çœŸæ­£çš„è‹±é›„ä¸»ä¹‰ï¼Œé‚£å°±æ˜¯åœ¨è®¤æ¸…ç”Ÿæ´»çš„çœŸç›¸åä¾ç„¶çƒ­çˆ±ç”Ÿæ´»ã€‚",
                from: "ç½—æ›¼.ç½—å…°ã€Šç±³å¼€æœ—åŸºç½—ã€‹"
            },
            {
                hitokoto: "ä¼—é‡Œå¯»ä»–åƒç™¾åº¦ï¼Œè“¦ç„¶å›é¦–ï¼Œé‚£äººå´åœ¨ç¯ç«é˜‘çŠå¤„ã€‚",
                from: "è¾›å¼ƒç–¾ã€Šé’ç‰æ¡ˆã€‹"
            },
            {
                hitokoto: "ä¸æ˜¯ä¸€ç•ªå¯’å½»éª¨ï¼Œæ€å¾—æ¢…èŠ±æ‰‘é¼»é¦™ã€‚",
                from: "é«˜æ˜ã€Šçµç¶è®°ã€‹"
            },
            {
                hitokoto: "å‰ªä¸æ–­ï¼Œç†è¿˜ä¹±ï¼Œæ˜¯ç¦»æ„ï¼Œåˆ«æ˜¯ä¸€ç•ªæ»‹å‘³åœ¨å¿ƒå¤´ã€‚",
                from: "æç…œ"
            },
            {
                hitokoto: "ä¸šç²¾äºå‹¤è’äºå¬‰ï¼Œè¡Œæˆäºæ€è€Œæ¯äºéšã€‚",
                from: "éŸ©æ„ˆ"
            },
            {
                hitokoto: "å¯Œè´µä¸èƒ½æ·«ï¼Œè´«è´±ä¸èƒ½ç§»ï¼Œå¨æ­¦ä¸èƒ½å±ˆã€‚",
                from: "å­Ÿå­"
            },
            {
                hitokoto: "å²æœˆå› é’æ˜¥æ…¨ç„¶ä»¥èµ´è€Œæ›´åŠ é™å¥½,ä¸–é—´å› å°‘å¹´æŒºèº«å‘å‰è€Œæ›´åŠ ç‘°ä¸½ã€‚",
                from: "ã€Šäººæ°‘æ—¥æŠ¥ã€‹"
            }
        ];

        try {
            const response = await fetch('https://v1.hitokoto.cn');
            const data = await response.json();
            
            // æ˜¾ç¤ºè·å–åˆ°çš„åœ¨çº¿è¯­å½•
            quoteCard.innerHTML = `
                <div class="quote-text"></div>
                ${data.from ? `<div class="quote-source">â€”â€” ${data.from}</div>` : ''}
            `;
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            requestAnimationFrame(() => {
                quoteCard.classList.add('visible');
                // æ·»åŠ æ‰“å­—æœºæ•ˆæœ
                const quoteText = quoteCard.querySelector('.quote-text');
                typeWriter(quoteText, data.hitokoto, 30);
            });
        } catch (error) {
            console.warn('è·å–åœ¨çº¿è¯­å½•å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°è¯­å½•:', error);
            
            // éšæœºé€‰æ‹©æœ¬åœ°è¯­å½•
            const randomIndex = Math.floor(Math.random() * localQuotes.length);
            const randomQuote = localQuotes[randomIndex];
            
            // æ˜¾ç¤ºæœ¬åœ°è¯­å½•
            quoteCard.innerHTML = `
                <div class="quote-text"></div>
                ${randomQuote.from ? `<div class="quote-source">â€”â€” ${randomQuote.from}</div>` : ''}
            `;
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            requestAnimationFrame(() => {
                quoteCard.classList.add('visible');
                // æ·»åŠ æ‰“å­—æœºæ•ˆæœ
                const quoteText = quoteCard.querySelector('.quote-text');
                typeWriter(quoteText, randomQuote.hitokoto, 30);
            });
        }
    }

    // å£çº¸ç³»ç»Ÿé‡æ„ä»£ç 
    class WallpaperManager {
        constructor() {
            // å£çº¸å®¹å™¨
            this.container = null;
            this.bingLayer = null;
            this.effectLayer = null;
            this.particlesLayer = null;
            
            // é…ç½®
            this.transitionDuration = 0.8;   // è¿‡æ¸¡åŠ¨ç”»æ—¶é•¿(ç§’)
            this.transitionEasing = 'cubic-bezier(0.4, 0, 0.2, 1)';
            this.loadTimeThreshold = 5000;    // å£çº¸åŠ è½½æ—¶é—´é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
            
            // å£çº¸APIåˆ—è¡¨
            this.wallpaperApis = [
                { url: 'https://api.timelessq.com/bing/random', params: '' },
                { url: 'https://api.bimg.cc/random', params: 'w=1920&h=1080&mkt=zh-CN' },
                { url: 'https://bing.img.run/rand.php', params: '' },
                { url: 'https://api.xsot.cn/bing', params: 'jump=true' }
            ];
            
            // ç²’å­åŠ¨ç”»é…ç½®
            this.particleSystem = null;
            
            // çŠ¶æ€
            this.keepAnimationOnly = false;    // æ˜¯å¦ä»…ä¿æŒåŠ¨ç”»
            this.wallpaperLoadTimeout = null;  // å£çº¸åŠ è½½è¶…æ—¶è®¡æ—¶å™¨
            
            // ç¼“å­˜é…ç½®
            this.currentCacheKey = 'current_wallpaper';  // å½“å‰å£çº¸ç¼“å­˜é”®
            this.nextCacheKey = 'next_wallpaper';        // ä¸‹ä¸€å¼ å£çº¸ç¼“å­˜é”®
            this.cacheExpiryTime = 24 * 60 * 60 * 1000;  // ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆ24å°æ—¶ï¼‰
            this.maxCacheSize = 1024 * 1024 * 5;         // æœ€å¤§ç¼“å­˜å¤§å°ï¼ˆ5MBï¼‰
            this.useCache = true;                        // æ˜¯å¦ä½¿ç”¨ç¼“å­˜
        }

        // åˆå§‹åŒ–å£çº¸å®¹å™¨
        initContainer() {
            // åˆ é™¤å¯èƒ½å·²å­˜åœ¨çš„å®¹å™¨
            const existingContainer = document.querySelector('.wallpaper-container');
            if (existingContainer) existingContainer.remove();
            
            // æ¸…é™¤ç°æœ‰è¶…æ—¶è®¡æ—¶å™¨
            if (this.wallpaperLoadTimeout) {
                clearTimeout(this.wallpaperLoadTimeout);
                this.wallpaperLoadTimeout = null;
            }
            
            // åˆ›å»ºå®¹å™¨
            this.container = document.createElement('div');
            this.container.className = 'wallpaper-container';
            Object.assign(this.container.style, {
                position: 'fixed',
                top: '0',
                left: '0',
                width: '100%',
                height: '100%',
                zIndex: '-1',
                overflow: 'hidden',
                backgroundColor: '#000000', // çº¯é»‘èƒŒæ™¯ä½œä¸ºåˆå§‹çŠ¶æ€
                opacity: '0', // åˆå§‹ä¸å¯è§
                transition: 'opacity 0.5s ease' // æ·»åŠ æ·¡å…¥æ•ˆæœ
            });
            
            // åˆ›å»ºç²’å­åŠ¨ç”»å±‚
            this.particlesLayer = document.createElement('div');
            this.particlesLayer.className = 'particles-layer';
            Object.assign(this.particlesLayer.style, {
                position: 'absolute',
                top: '0',
                left: '0',
                width: '100%',
                height: '100%',
                background: 'linear-gradient(135deg, #0f1726 0%, #171b2e 100%)',
                zIndex: '0',
                opacity: '0',
                transition: 'opacity 1.2s ease'
            });
            
            // åˆ›å»ºç²’å­ç”»å¸ƒ
            const canvas = document.createElement('canvas');
            canvas.className = 'particles-canvas';
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            Object.assign(canvas.style, {
                position: 'absolute',
                top: '0',
                left: '0',
                width: '100%',
                height: '100%'
            });
            this.particlesLayer.appendChild(canvas);
            
            // åˆ›å»ºå¿…åº”å£çº¸å±‚
            this.bingLayer = document.createElement('div');
            this.bingLayer.className = 'wallpaper-layer bing-layer';
            Object.assign(this.bingLayer.style, {
                position: 'absolute',
                top: '0',
                left: '0',
                width: '100%',
                height: '100%',
                backgroundPosition: 'center',
                backgroundSize: 'cover',
                opacity: '0',
                transform: 'scale(1.1)', // åˆå§‹æ”¾å¤§æ•ˆæœ
                transition: `opacity ${this.transitionDuration}s ${this.transitionEasing}, transform ${this.transitionDuration}s ${this.transitionEasing}`,
                zIndex: '2'
            });
            
            // åˆ›å»ºæ™¯æ·±æ•ˆæœå±‚
            this.effectLayer = document.createElement('div');
            this.effectLayer.className = 'wallpaper-effect-layer';
            Object.assign(this.effectLayer.style, {
                position: 'absolute',
                top: '0',
                left: '0',
                width: '100%',
                height: '100%',
                background: 'radial-gradient(circle at center, rgba(0,0,0,0) 0%, rgba(0,0,0,0.15) 100%)',
                boxShadow: 'inset 0 0 150px rgba(0,0,0,0.3)',
                zIndex: '3',
                pointerEvents: 'none',
                mixBlendMode: 'normal',
                opacity: '0',
                transition: 'opacity 1s ease'
            });
            
            // æ·»åŠ åˆ°å®¹å™¨
            this.container.appendChild(this.particlesLayer);
            this.container.appendChild(this.bingLayer);
            this.container.appendChild(this.effectLayer);
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(this.container);
            
            // åˆå§‹åŒ–ç²’å­ç³»ç»Ÿ
            this.particleSystem = new ParticleSystem(canvas, {
                baseSpeed: 0.2,
                addedSpeed: 0.3,
                count: 150,
                baseSize: 3,
                addedSize: 4,
                opacityBase: 0.5,
                opacityAdded: 0.5
            });
            
            // è°ƒæ•´çª—å£å¤§å°æ—¶çš„å¤„ç†
            window.addEventListener('resize', () => {
                if (this.particleSystem) {
                    this.particleSystem.handleResize();
                }
            });
            
            // æ˜¾ç¤ºå®¹å™¨
            requestAnimationFrame(() => {
                this.container.style.opacity = '1';
            });
            
            return this;
        }
        
        // å¯åŠ¨ç²’å­åŠ¨ç”»èƒŒæ™¯
        activateParticlesBackground() {
            if (this.particlesLayer && this.effectLayer) {
                // æ¸…é™¤å£çº¸åŠ è½½è¶…æ—¶
                if (this.wallpaperLoadTimeout) {
                    clearTimeout(this.wallpaperLoadTimeout);
                    this.wallpaperLoadTimeout = null;
                }
                
                // è®¾ç½®ä¿æŒåŠ¨ç”»çŠ¶æ€æ ‡å¿—
                this.keepAnimationOnly = true;
                
                // å¯åŠ¨ç²’å­ç³»ç»Ÿ
                if (this.particleSystem) {
                    this.particleSystem.start();
                }
                
                // æ·¡å…¥æ˜¾ç¤ºç²’å­å±‚å’Œæ•ˆæœå±‚
                this.particlesLayer.style.opacity = '1';
                this.effectLayer.style.opacity = '1';
                
                console.log('å·²åˆ‡æ¢åˆ°ç²’å­åŠ¨ç”»èƒŒæ™¯');
            }
        }
        
        // éšè—ç²’å­èƒŒæ™¯æ–¹æ³•
        hideParticlesBackground() {
            if (this.particlesLayer) {
                // æ·¡å‡ºç²’å­å±‚
                this.particlesLayer.style.opacity = '0';
                
                // åœæ­¢ç²’å­åŠ¨ç”»
                if (this.particleSystem) {
                    // åœ¨è¿‡æ¸¡å®Œæˆååœæ­¢ç²’å­åŠ¨ç”»ä»¥èŠ‚çœèµ„æº
                    setTimeout(() => {
                        this.particleSystem.stop();
                    }, 1200); // ä¸ç²’å­å±‚æ·¡å‡ºè¿‡æ¸¡æ—¶é—´åŒ¹é…
                }
            }
        }
        
        // é¢„åŠ è½½å›¾ç‰‡å‡½æ•°
        preloadImage(url) {
            return new Promise((resolve, reject) => {
                const loadStartTime = Date.now();
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å¿…åº”å£çº¸URL
                const isBingUrl = url.includes('api.bimg.cc') || url.includes('bingw.com') || 
                                  url.includes('bing.img.run') || url.includes('api.xsot.cn');
                
                // å¦‚æœæ˜¯å¿…åº”å£çº¸URLï¼Œä½¿ç”¨fetchå…ˆå¤„ç†é‡å®šå‘
                if (isBingUrl) {
                    console.log('æ£€æµ‹åˆ°å¿…åº”å£çº¸URLï¼Œä½¿ç”¨fetchå¤„ç†é‡å®šå‘:', url);
                    
                    // ä½¿ç”¨fetchè·å–å®é™…URLï¼ˆå…è®¸é‡å®šå‘ï¼‰
                    fetch(url, {
                        method: 'GET',
                        redirect: 'follow',
                        cache: 'no-store' // ç¦ç”¨ç¼“å­˜
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        // åˆ›å»ºæœ¬åœ°URL
                        const localUrl = URL.createObjectURL(blob);
                        
                        // åŠ è½½æœ¬åœ°URL
                        const img = new Image();
                        
                        // è®¾ç½®è¶…æ—¶
                        const timeoutId = setTimeout(() => {
                            URL.revokeObjectURL(localUrl);
                            reject(new Error(`å›¾ç‰‡åŠ è½½è¶…æ—¶: ${url}`));
                        }, this.loadTimeThreshold);
                        
                        img.onload = () => {
                            clearTimeout(timeoutId);
                            const loadTime = Date.now() - loadStartTime;
                            console.log(`å¿…åº”å£çº¸é‡å®šå‘ååŠ è½½æˆåŠŸï¼Œæ€»è€—æ—¶: ${loadTime}ms`);
                            resolve({ url: localUrl, loadTime, originalUrl: url });
                        };
                        
                        img.onerror = () => {
                            clearTimeout(timeoutId);
                            URL.revokeObjectURL(localUrl);
                            reject(new Error(`å›¾ç‰‡åŠ è½½å¤±è´¥(é‡å®šå‘å): ${url}`));
                        };
                        
                        img.src = localUrl;
                    })
                    .catch(error => {
                        console.error('fetchå¤„ç†é‡å®šå‘å¤±è´¥:', error);
                        reject(error);
                    });
                } else {
                    // æ™®é€šå›¾ç‰‡ç›´æ¥åŠ è½½
                    // è®¾ç½®è¶…æ—¶è®¡æ—¶å™¨
                    const timeoutId = setTimeout(() => {
                        reject(new Error(`å›¾ç‰‡åŠ è½½è¶…æ—¶: ${url}`));
                    }, this.loadTimeThreshold);
                    
                    const img = new Image();
                    
                    img.onload = () => {
                        clearTimeout(timeoutId);
                        const loadTime = Date.now() - loadStartTime;
                        resolve({ url, loadTime });
                    };
                    
                    img.onerror = () => {
                        clearTimeout(timeoutId);
                        reject(new Error(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${url}`));
                    };
                    
                    img.src = url;
                }
            });
        }
        
        // è·å–API URLåˆ—è¡¨
        getApiUrls() {
            // ä¸ºæ¯ä¸ªAPIæ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
            return this.wallpaperApis.map(api => {
                const timestamp = Date.now();
                const separator = api.params ? '&' : '?';
                return `${api.url}${api.params ? '?' + api.params : ''}${separator}t=${timestamp}`;
            });
        }
        
        // ç«é€ŸåŠ è½½å¤šä¸ªAPIï¼Œè¿”å›æœ€å¿«åŠ è½½æˆåŠŸçš„ç»“æœ
        async raceWallpaperApis() {
            const apiUrls = this.getApiUrls();
            console.log('æ­£åœ¨ç«é€ŸåŠ è½½å£çº¸ï¼ŒAPIæ•°é‡:', apiUrls.length);
            
            // åˆ›å»ºåŠ è½½Promiseæ•°ç»„ï¼Œæ¯ä¸ªéƒ½å¸¦æœ‰è¶…æ—¶å¤„ç†
            const loadPromises = apiUrls.map(url => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    const timeoutId = setTimeout(() => {
                        img.src = ''; // æ¸…é™¤å›¾ç‰‡æº
                        reject(new Error(`å›¾ç‰‡åŠ è½½è¶…æ—¶: ${url}`));
                    }, this.loadTimeThreshold);
                    
                    img.onload = () => {
                        clearTimeout(timeoutId);
                        const loadTime = Date.now() - loadStartTime;
                        console.log(`API ${url} åŠ è½½æˆåŠŸï¼Œè€—æ—¶: ${loadTime}ms`);
                        resolve({ url: url, loadTime, apiUrl: url });
                    };
                    
                    img.onerror = () => {
                        clearTimeout(timeoutId);
                        reject(new Error(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${url}`));
                    };
                    
                    const loadStartTime = Date.now();
                    img.src = url;
                });
            });
            
            // ä½¿ç”¨Promise.anyæ¥è·å–ç¬¬ä¸€ä¸ªæˆåŠŸçš„ç»“æœ
            try {
                return await Promise.any(loadPromises);
            } catch (error) {
                // æ‰€æœ‰APIéƒ½å¤±è´¥
                console.error('æ‰€æœ‰å£çº¸APIåŠ è½½å‡å¤±è´¥');
                throw new Error('æ‰€æœ‰å£çº¸APIåŠ è½½å¤±è´¥');
            }
        }
        
        // æ£€æŸ¥å£çº¸ç¼“å­˜
        checkWallpaperCache(cacheKey) {
            if (!this.useCache) return null;
            
            try {
                const cacheData = localStorage.getItem(cacheKey);
                if (!cacheData) return null;
                
                const cache = JSON.parse(cacheData);
                const now = Date.now();
                
                // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ
                if (now - cache.timestamp > this.cacheExpiryTime) {
                    console.log(`å£çº¸ç¼“å­˜ ${cacheKey} å·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°è·å–`);
                    localStorage.removeItem(cacheKey);
                    return null;
                }
                
                console.log(`å‘ç°æœ‰æ•ˆçš„å£çº¸ç¼“å­˜ ${cacheKey}ï¼Œä¸Šæ¬¡ç¼“å­˜æ—¶é—´:`, new Date(cache.timestamp).toLocaleString());
                return cache;
            } catch (error) {
                console.warn(`è¯»å–å£çº¸ç¼“å­˜ ${cacheKey} å¤±è´¥:`, error);
                localStorage.removeItem(cacheKey);
                return null;
            }
        }
        
        // ç¼“å­˜å£çº¸æ•°æ®
        cacheWallpaper(imageData, imageUrl, cacheKey) {
            if (!this.useCache) return;
            
            try {
                // åˆ›å»ºç¼“å­˜å¯¹è±¡
                const cache = {
                    data: imageData,
                    url: imageUrl,
                    timestamp: Date.now()
                };
                
                // ä¼°è®¡ç¼“å­˜å¤§å°
                const cacheSize = JSON.stringify(cache).length;
                
                // æ£€æŸ¥ç¼“å­˜å¤§å°æ˜¯å¦è¶…è¿‡é™åˆ¶
                if (cacheSize > this.maxCacheSize) {
                    console.warn(`å£çº¸ç¼“å­˜ ${cacheKey} å¤§å°è¶…è¿‡é™åˆ¶ï¼Œä¸è¿›è¡Œç¼“å­˜`);
                    return;
                }
                
                // å­˜å‚¨ç¼“å­˜
                localStorage.setItem(cacheKey, JSON.stringify(cache));
                console.log(`å£çº¸å·²ç¼“å­˜åˆ° ${cacheKey}ï¼Œå¤§å°:`, (cacheSize / 1024).toFixed(2), 'KB');
            } catch (error) {
                console.warn(`ç¼“å­˜å£çº¸åˆ° ${cacheKey} å¤±è´¥:`, error);
                // å¦‚æœç¼“å­˜å¤±è´¥ï¼ˆä¾‹å¦‚localStorageå·²æ»¡ï¼‰ï¼Œæ¸…é™¤ç¼“å­˜é”®
                try {
                    localStorage.removeItem(cacheKey);
                } catch (e) {
                    // å¿½ç•¥æ¸…é™¤å¤±è´¥çš„é”™è¯¯
                }
            }
        }
        
        // ä»ç¼“å­˜åŠ è½½å£çº¸
        async loadWallpaperFromCache(cacheKey) {
            try {
                const cache = this.checkWallpaperCache(cacheKey);
                if (!cache) return false;
                
                console.log(`æ­£åœ¨ä»ç¼“å­˜ ${cacheKey} åŠ è½½å£çº¸...`);
                
                // ä»Base64æ•°æ®åˆ›å»ºBlobå¯¹è±¡
                const binary = atob(cache.data);
                const array = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    array[i] = binary.charCodeAt(i);
                }
                const blob = new Blob([array], { type: 'image/jpeg' });
                
                // åˆ›å»ºObjectURL
                const objectUrl = URL.createObjectURL(blob);
                
                // åŠ è½½ç¼“å­˜çš„å›¾ç‰‡
                const img = new Image();
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = objectUrl;
                });
                
                // è®¾ç½®å£çº¸
                this.bingLayer.style.backgroundImage = `url('${objectUrl}')`;
                
                // æ·»åŠ å›¾ç‰‡å…ƒç´ ä»¥ç¡®ä¿æ˜¾ç¤º
                this.bingLayer.innerHTML = '';
                const imgElement = document.createElement('img');
                imgElement.src = objectUrl;
                imgElement.style.cssText = 'position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;';
                this.bingLayer.appendChild(imgElement);
                
                // æ˜¾ç¤ºå£çº¸å’Œæ•ˆæœå±‚
                requestAnimationFrame(() => {
                    if (!this.keepAnimationOnly) {
                        this.bingLayer.style.opacity = '1';
                        this.bingLayer.style.transform = 'scale(1)';
                        this.effectLayer.style.opacity = '1';
                        
                        // éšè—ç²’å­åŠ¨ç”»å±‚
                        this.hideParticlesBackground();
                    }
                });
                
                console.log(`ä»ç¼“å­˜ ${cacheKey} åŠ è½½å£çº¸æˆåŠŸ`);
                return true;
            } catch (error) {
                console.warn(`ä»ç¼“å­˜ ${cacheKey} åŠ è½½å£çº¸å¤±è´¥:`, error);
                return false;
            }
        }
        
        // é¢„åŠ è½½ä¸‹ä¸€å¼ å£çº¸å¹¶ç¼“å­˜
        async preloadNextWallpaper() {
            try {
                console.log('å¼€å§‹é¢„åŠ è½½ä¸‹ä¸€å¼ å£çº¸...');
                
                // ç«é€ŸåŠ è½½å¤šä¸ªAPIè·å–ä¸‹ä¸€å¼ å£çº¸
                const { url, loadTime, originalUrl, apiUrl } = await this.raceWallpaperApis();
                
                // ä½¿ç”¨é‡å®šå‘åçš„å®é™…URL
                const actualUrl = url || originalUrl;
                console.log(`ä¸‹ä¸€å¼ å£çº¸é¢„åŠ è½½æˆåŠŸï¼Œæ¥æº: ${apiUrl}ï¼Œè€—æ—¶: ${loadTime}ms`);
                
                // è·å–å›¾ç‰‡çš„Base64æ•°æ®å¹¶ç¼“å­˜åˆ°next_wallpaperé”®
                const imageData = await this.getImageAsBase64(actualUrl);
                this.cacheWallpaper(imageData, apiUrl, this.nextCacheKey);
                
                console.log('ä¸‹ä¸€å¼ å£çº¸å·²æˆåŠŸç¼“å­˜');
            } catch (error) {
                console.error('é¢„åŠ è½½ä¸‹ä¸€å¼ å£çº¸å¤±è´¥:', error);
            }
        }

        // è·å–å¹¶ç¼“å­˜å›¾ç‰‡çš„Base64æ•°æ®
        async getImageAsBase64(url) {
            try {
                // ä½¿ç”¨fetchè·å–å›¾ç‰‡
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
            
                // è·å–blobæ•°æ®
                const blob = await response.blob();
                
                // è½¬æ¢ä¸ºBase64
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        // ä»DataURLä¸­æå–Base64å­—ç¬¦ä¸²
                        const base64String = reader.result.split(',')[1];
                        resolve(base64String);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error('è·å–å›¾ç‰‡Base64æ•°æ®å¤±è´¥:', error);
                throw error;
            }
        }

        // åŠ è½½å¹¶æ˜¾ç¤ºå¿…åº”å£çº¸
        async loadBingWallpaper() {
            try {
                // å°†ä¸Šæ¬¡ç¼“å­˜çš„"ä¸‹ä¸€å¼ å£çº¸"ä½œä¸ºå½“å‰å£çº¸
                const nextCache = this.checkWallpaperCache(this.nextCacheKey);
                if (nextCache) {
                    // å°†"ä¸‹ä¸€å¼ "å£çº¸ç§»åŠ¨åˆ°"å½“å‰"å£çº¸ç¼“å­˜
                    localStorage.setItem(this.currentCacheKey, localStorage.getItem(this.nextCacheKey));
                    // æ¸…é™¤"ä¸‹ä¸€å¼ "å£çº¸ç¼“å­˜
                    localStorage.removeItem(this.nextCacheKey);
                }
                
                // å°è¯•ä»å½“å‰å£çº¸ç¼“å­˜åŠ è½½
                if (await this.loadWallpaperFromCache(this.currentCacheKey)) {
                    // æˆåŠŸä»ç¼“å­˜åŠ è½½ï¼Œå¼€å§‹å¼‚æ­¥é¢„åŠ è½½ä¸‹ä¸€å¼ å£çº¸
                    setTimeout(() => this.preloadNextWallpaper(), 1000);
                    return true;
                }
                
                // è®¾ç½®è¶…æ—¶è®¡æ—¶å™¨ï¼Œå¦‚æœåŠ è½½æ—¶é—´è¿‡é•¿åˆ™æ˜¾ç¤ºç²’å­åŠ¨ç”»
                this.wallpaperLoadTimeout = setTimeout(() => {
                    this.activateParticlesBackground();
                }, this.loadTimeThreshold);
                
                console.log('æ— å¯ç”¨ç¼“å­˜ï¼Œå¼€å§‹å¹¶è¡ŒåŠ è½½å¤šä¸ªå£çº¸API');
                
                // ç«é€ŸåŠ è½½å¤šä¸ªAPI
                const { url, loadTime, originalUrl, apiUrl } = await this.raceWallpaperApis();
                
                // æ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨
                if (this.wallpaperLoadTimeout) {
                    clearTimeout(this.wallpaperLoadTimeout);
                    this.wallpaperLoadTimeout = null;
                }
                
                // å¦‚æœå·²ç»åˆ‡æ¢åˆ°åŠ¨ç”»æ¨¡å¼ï¼Œåˆ™ä¸è®¾ç½®å£çº¸
                if (this.keepAnimationOnly) {
                    console.log('åœ¨åŠ è½½è¿‡ç¨‹ä¸­å·²åˆ‡æ¢åˆ°ç²’å­åŠ¨ç”»æ¨¡å¼ï¼Œä¸è®¾ç½®å£çº¸');
                    return;
                }
                
                // ä½¿ç”¨é‡å®šå‘åçš„å®é™…URL
                const actualUrl = url || originalUrl;
                console.log(`å£çº¸åŠ è½½æˆåŠŸï¼Œæ¥æº: ${apiUrl}ï¼Œè€—æ—¶: ${loadTime}ms`);
                
                // é¢„åŠ è½½å›¾ç‰‡
                const img = new Image();
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = actualUrl;
                });
                
                // è®¾ç½®å¿…åº”å£çº¸
                this.bingLayer.style.backgroundImage = `url('${actualUrl}')`;
                
                // æ·»åŠ å›¾ç‰‡å…ƒç´ ä»¥ç¡®ä¿æ˜¾ç¤º
                this.bingLayer.innerHTML = '';
                const imgElement = document.createElement('img');
                imgElement.src = actualUrl;
                imgElement.style.cssText = 'position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;';
                this.bingLayer.appendChild(imgElement);
                
                // æ˜¾ç¤ºå£çº¸å’Œæ•ˆæœå±‚
                requestAnimationFrame(() => {
                    if (!this.keepAnimationOnly) {
                        this.bingLayer.style.opacity = '1';
                        this.bingLayer.style.transform = 'scale(1)'; // ç¼©æ”¾åŠ¨ç”»
                        this.effectLayer.style.opacity = '1';
                        
                        // éšè—ç²’å­åŠ¨ç”»å±‚
                        this.hideParticlesBackground();
                    }
                });
                
                // ç¼“å­˜å£çº¸
                try {
                    // è·å–å›¾ç‰‡çš„Base64æ•°æ®å¹¶ç¼“å­˜åˆ°å½“å‰å£çº¸ç¼“å­˜
                    const imageData = await this.getImageAsBase64(actualUrl);
                    this.cacheWallpaper(imageData, apiUrl, this.currentCacheKey);
                    
                    // å¼‚æ­¥é¢„åŠ è½½ä¸‹ä¸€å¼ å£çº¸
                    setTimeout(() => this.preloadNextWallpaper(), 1000);
                } catch (cacheError) {
                    console.warn('ç¼“å­˜å£çº¸è¿‡ç¨‹ä¸­å‡ºé”™:', cacheError);
                    // ç¼“å­˜é”™è¯¯ä¸å½±å“å£çº¸æ˜¾ç¤º
                }
                
                return true;
            } catch (error) {
                console.error('å£çº¸åŠ è½½å¤±è´¥ï¼Œå¯ç”¨ç²’å­åŠ¨ç”»èƒŒæ™¯:', error);
                this.activateParticlesBackground();
                return false;
            }
        }
        
        // ä¸»æ–¹æ³•ï¼šè®¾ç½®å£çº¸
        async setWallpaper() {
            try {
                // é‡ç½®çŠ¶æ€
                this.keepAnimationOnly = false;
                
                // åˆå§‹åŒ–å®¹å™¨
                this.initContainer();
                
                // ç¡®ä¿å£çº¸å±‚åˆå§‹æ˜¯ç©ºçš„
                this.bingLayer.innerHTML = '';
                this.bingLayer.style.backgroundImage = 'none';
                this.bingLayer.style.opacity = '0';
                
                console.log('[WallpaperManager] å·²é‡ç½®å£çº¸å±‚');
                
                // åŠ è½½å¹¶æ˜¾ç¤ºå£çº¸
                await this.loadBingWallpaper();
                
            } catch (error) {
                console.error('è®¾ç½®å£çº¸å¤±è´¥ï¼Œå¯ç”¨ç²’å­åŠ¨ç”»èƒŒæ™¯:', error);
                this.activateParticlesBackground();
            }
        }
    }

    // å¯¼å…¥ SearchAPI ç±»
    import SearchAPI from './search.js';

    // é‡æ–°æ·»åŠ  updateTime å‡½æ•°
    function updateTime() {
        // è·å–è®¾ç½®ç®¡ç†å™¨å®ä¾‹
        const settingsManager = window.settingsManager;
        
        // è·å–å½“å‰æ—¶é—´
        const now = new Date();
        
        // æ ¹æ®æ—¶åŒºè®¾ç½®è°ƒæ•´æ—¶é—´
        let adjustedTime = now;
        
        if (settingsManager && settingsManager.settings.timezone !== 'auto') {
            // è·å–æœ¬åœ°æ—¶åŒºåç§»ï¼ˆåˆ†é’Ÿï¼‰
            const localOffset = now.getTimezoneOffset();
            
            // è®¡ç®—ç›®æ ‡æ—¶åŒºä¸UTCçš„åç§»ï¼ˆåˆ†é’Ÿï¼‰
            const targetOffset = -settingsManager.settings.timezoneOffset * 60;
            
            // è®¡ç®—æ—¶å·®ï¼ˆæ¯«ç§’ï¼‰
            const offsetDiff = (localOffset + targetOffset) * 60 * 1000;
            
            // è°ƒæ•´æ—¶é—´
            adjustedTime = new Date(now.getTime() + offsetDiff);
        }
        
        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        const hours = String(adjustedTime.getHours()).padStart(2, '0');
        const minutes = String(adjustedTime.getMinutes()).padStart(2, '0');
        document.querySelector('.time').textContent = `${hours}:${minutes}`;
        
        // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
        const year = adjustedTime.getFullYear();
        const month = String(adjustedTime.getMonth() + 1).padStart(2, '0');
        const day = String(adjustedTime.getDate()).padStart(2, '0');
        const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
        const weekday = weekdays[adjustedTime.getDay()];
        document.querySelector('.date').textContent = `${year}å¹´${month}æœˆ${day}æ—¥ ${weekday}`;
    }

    // æ·»åŠ æ‰“å­—æœºæ•ˆæœå‡½æ•°
    function typeWriter(element, text, speed = 50) {
        let i = 0;
        element.textContent = '';
        const timer = setInterval(() => {
            if (i < text.length) {
                element.textContent += text.charAt(i);
                i++;
            } else {
                clearInterval(timer);
            }
        }, speed);
    }

    // æ˜¾ç¤ºæœç´¢ç»“æœ
    function showResults(results) {
        const resultsContainer = document.querySelector('.results-container');
        const resultsDiv = document.querySelector('.results');
        const statsDiv = document.querySelector('.results-stats');
        const resultsSearchInput = document.querySelector('.results-search-input');
        
        resultsSearchInput.value = document.querySelector('.search-input').value;
        statsDiv.textContent = `æ‰¾åˆ°çº¦ ${results.data.length} æ¡ç»“æœ`;
        
        resultsDiv.innerHTML = results.data.map(item => `
            <div class="result-card">
                <div class="result-title" onclick="window.open('${item.href}', '_blank')">${item.title}</div>
                <div class="result-url">${formatUrl(item.href)}</div>
                <div class="result-snippet">${item.abstract}</div>
                ${item.time ? `
                    <div class="result-meta">
                        <span class="result-time">${formatTime(item.time)}</span>
                    </div>
                ` : ''}
            </div>
        `).join('');

        resultsContainer.style.display = 'block';
        setTimeout(() => resultsContainer.style.opacity = '1', 10);
    }

    // æ ¼å¼åŒ–URLæ˜¾ç¤º
    function formatUrl(url) {
        try {
            const urlObj = new URL(url);
            return urlObj.hostname + urlObj.pathname.slice(0, 50) + (urlObj.pathname.length > 50 ? '...' : '');
        } catch {
            return url;
        }
    }

    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
    function formatTime(time) {
        const date = new Date(time);
        const now = new Date();
        const diff = now - date;
        
        // å¦‚æœæ—¶é—´å·®å°äº24å°æ—¶ï¼Œæ˜¾ç¤º"xå°æ—¶å‰"
        if (diff < 24 * 60 * 60 * 1000) {
            const hours = Math.floor(diff / (60 * 60 * 1000));
            return `${hours}å°æ—¶å‰`;
        }
        
        // å¦åˆ™æ˜¾ç¤ºå…·ä½“æ—¥æœŸ
        return time.split(' ')[0];
    }

    // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
    function updateDate() {
        const now = new Date();
        const days = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
        const dateStr = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥ ${days[now.getDay()]}`;
        document.querySelector('.date').textContent = dateStr;
    }

    // æ¨¡æ‹Ÿè·å–å¤©æ°”æ•°æ®
    async function getWeather() {
        try {
            // è¿™é‡Œå¯ä»¥æ›¿æ¢ä¸ºå®é™…çš„å¤©æ°”APIè°ƒç”¨
            const weatherIcons = ['â˜€ï¸', 'â›…', 'â˜ï¸', 'ğŸŒ§ï¸', 'â›ˆï¸', 'â„ï¸'];
            const weatherDescs = ['æ™´æœ—', 'å¤šäº‘', 'é˜´å¤©', 'å°é›¨', 'é›·é›¨', 'å°é›ª'];
            const randomIndex = Math.floor(Math.random() * weatherIcons.length);
            const temp = Math.floor(Math.random() * 15) + 15; // 15-30åº¦ä¹‹é—´
            
            const weatherCard = document.querySelector('.weather-card');
            if (weatherCard) {
                weatherCard.querySelector('.weather-icon').textContent = weatherIcons[randomIndex];
                weatherCard.querySelector('.weather-temp').textContent = `${temp}Â°C`;
                weatherCard.querySelector('.weather-desc').textContent = weatherDescs[randomIndex];
                
                setTimeout(() => {
                    weatherCard.classList.add('visible');
                }, 1000);
            }
        } catch (error) {
            console.error('è·å–å¤©æ°”å¤±è´¥:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const wallpaperManager = new WallpaperManager();
        wallpaperManager.setWallpaper();
        
        // åˆå§‹åŒ–è®¾ç½®ç³»ç»Ÿ
        const settingsManager = new SettingsManager();
        settingsManager.init();
        
        // è·å–æ‰€æœ‰éœ€è¦çš„DOMå…ƒç´ 
        const searchContainer = document.querySelector('.search-container');
        const searchInput = document.querySelector('.search-input');
        const resultsSearchInput = document.querySelector('.results-search-input');
        const searchBtn = document.querySelector('.search-btn');
        const resultsContainer = document.querySelector('.results-container');
        const closeResults = document.querySelector('.close-results');
        const body = document.body;

        // åˆå§‹åŒ–
        updateTime();
        setInterval(updateTime, 1000);
        
        // åˆå§‹è·å–è¯­å½•
        getQuote();
        
        // æ·»åŠ å…¨å±€å˜é‡è·Ÿè¸ªå®šæ—¶å™¨
        let quoteRefreshTimer = setInterval(getQuote, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
        
        // æ·»åŠ é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // é¡µé¢å¯è§æ—¶ï¼Œå¦‚æœå®šæ—¶å™¨ä¸å­˜åœ¨åˆ™é‡æ–°å¯åŠ¨
                if (!quoteRefreshTimer) {
                    quoteRefreshTimer = setInterval(getQuote, 30000);
                }
                // ç«‹å³åˆ·æ–°ä¸€æ¬¡è¯­å½•
                getQuote();
            } else {
                // é¡µé¢ä¸å¯è§æ—¶ï¼Œæ¸…é™¤å®šæ—¶å™¨
                clearInterval(quoteRefreshTimer);
                quoteRefreshTimer = null;
            }
        });

        // æ¸…é™¤æœç´¢æ¡†å†…å®¹å¹¶ç¦ç”¨è‡ªåŠ¨å¡«å……
        if (searchInput) {
            searchInput.value = '';
            searchInput.setAttribute('autocomplete', 'off');
        }
        
        if (resultsSearchInput) {
            resultsSearchInput.value = '';
            resultsSearchInput.setAttribute('autocomplete', 'off');
        }

        // æ·»åŠ é¡µé¢é‡æ–°è·å¾—ç„¦ç‚¹æ—¶çš„å¤„ç†
        window.addEventListener('focus', () => {
            if (searchInput) searchInput.value = '';
            if (resultsSearchInput) resultsSearchInput.value = '';
        });

        // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        searchBtn.addEventListener('click', () => {
            if (!searchContainer.classList.contains('active')) {
                searchContainer.classList.add('active');
                body.classList.add('search-active');
                setTimeout(() => searchInput.focus(), 300);
            } else if (searchInput.value.trim()) {
                performSearch(searchInput.value.trim());
            }
        });

        // æœç´¢æ¡†è·å¾—ç„¦ç‚¹äº‹ä»¶
        searchInput.addEventListener('focus', () => {
            if (!searchContainer.classList.contains('active')) {
                searchContainer.classList.add('active');
                body.classList.add('search-active');
            }
        });

        // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­æœç´¢æ¡†
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container') && searchContainer.classList.contains('active')) {
                searchContainer.classList.remove('active');
                body.classList.remove('search-active');
            }
            
            // ç¡®ä¿ç‚¹å‡»ç©ºç™½å¤„ä¹Ÿå…³é—­æœç´¢å¼•æ“ä¸‹æ‹‰èœå•
            if (!e.target.closest('.search-engine-selector')) {
                engineDropdown.classList.remove('show');
            }
        });

        // é˜»æ­¢æœç´¢æ¡†å†…çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
        searchContainer.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // ä¿®æ”¹å›è½¦é”®å¤„ç†
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (!searchContainer.classList.contains('active')) {
                    searchContainer.classList.add('active');
                    body.classList.add('search-active');
                    setTimeout(() => searchInput.focus(), 300);
                } else if (searchInput.value.trim()) {
                    performSearch(searchInput.value.trim());
                }
            }
        });

        // ä¿®æ”¹å…³é—­ç»“æœé¡µé¢æ—¶çš„å¤„ç†
        closeResults.addEventListener('click', () => {
            const resultsContainer = document.querySelector('.results-container');
            const searchContainer = document.querySelector('.search-container');
            const initialContent = document.querySelector('.time, .quote-card');
            const searchInput = document.querySelector('.search-input');
            const resultsSearchInput = document.querySelector('.results-search-input');
            
            // ç§»é™¤ç»“æœé¡µå¯è§æ€§
            resultsContainer.classList.remove('visible');
            document.querySelector('.web-results-column').classList.remove('visible');
            document.querySelector('.ai-results-column').classList.remove('visible');
            
            // æ¢å¤èµ·å§‹é¡µå†…å®¹
            searchContainer.style.transition = 'all 0.6s cubic-bezier(0.19, 1, 0.22, 1)';
            searchContainer.style.transform = 'translateY(0)';
            searchContainer.style.opacity = '1';
            initialContent.style.transition = 'opacity 0.6s ease';
            initialContent.style.opacity = '1';
            
            // é‡ç½®æœç´¢æ¡†çŠ¶æ€
            searchContainer.classList.remove('active');
            body.classList.remove('search-active');
            
            // æ¸…é™¤æ‰€æœ‰æœç´¢æ¡†çš„å†…å®¹
            searchInput.value = '';
            resultsSearchInput.value = '';
            
            // ç­‰å¾…åŠ¨ç”»å®Œæˆåæ¸…ç†
            setTimeout(() => {
                resultsContainer.style.display = 'none';
                document.querySelector('.web-results').innerHTML = '';
                document.querySelector('.ai-messages').innerHTML = '';
            }, 600);
        });

        // æœç´¢å¼•æ“é€‰æ‹©ç›¸å…³
        const engineSelector = document.querySelector('.search-engine-selector');
        const engineDropdown = document.querySelector('.search-engine-dropdown');
        const currentEngineIcon = document.getElementById('currentEngine');
        let currentEngine = 'bing'; // é»˜è®¤æœç´¢å¼•æ“

        // è¯»å–ä¿å­˜çš„æœç´¢å¼•æ“è®¾ç½®
        const savedEngine = localStorage.getItem('selectedEngine');
        if (savedEngine) {
            currentEngine = savedEngine;
            const option = document.querySelector(`.search-engine-option[data-engine="${savedEngine}"]`);
            if (option) {
                currentEngineIcon.src = option.getAttribute('data-icon');
                if (savedEngine === 'ai') {
                    searchInput.placeholder = 'è¯·è¾“å…¥';
                }
            }
        }

        // å¤„ç†æœç´¢å¼•æ“é€‰æ‹©å™¨ç‚¹å‡»äº‹ä»¶
        engineSelector.addEventListener('click', function(e) {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            
            // éšè—æœç´¢è”æƒ³æ¡†
            const suggestionsBox = document.querySelector('.search-suggestions');
            if (suggestionsBox) {
                suggestionsBox.style.display = 'none';
            }
            
            // åˆ‡æ¢ä¸‹æ‹‰èœå•æ˜¾ç¤ºçŠ¶æ€
            if (engineDropdown.style.display === 'block') {
                engineDropdown.style.display = 'none';
            } else {
                engineDropdown.style.display = 'block';
                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                engineDropdown.classList.add('animate-dropdown');
                setTimeout(() => engineDropdown.classList.remove('animate-dropdown'), 300);
            }
        });

        // å¤„ç†æœç´¢å¼•æ“é€‰é¡¹ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.search-engine-option').forEach(option => {
            option.addEventListener('click', function(e) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                
                // è·å–æ‰€é€‰æœç´¢å¼•æ“ä¿¡æ¯
                const engine = this.getAttribute('data-engine');
                const icon = this.getAttribute('data-icon');
                
                // æ›´æ–°å½“å‰æœç´¢å¼•æ“å˜é‡ - è¿™æ˜¯ä¿®å¤çš„å…³é”®
                currentEngine = engine;
                
                // æ›´æ–°å½“å‰æœç´¢å¼•æ“å›¾æ ‡
                currentEngineIcon.src = icon;
                
                // å­˜å‚¨æ‰€é€‰æœç´¢å¼•æ“
                localStorage.setItem('selectedEngine', engine);
                
                // éšè—ä¸‹æ‹‰èœå•
                engineDropdown.style.display = 'none';
                
                // æ›´æ–°æœç´¢æ¡†æç¤ºæ–‡æœ¬
                if (engine === 'ai') {
                    searchInput.placeholder = 'è¯·è¾“å…¥';
                } else {
                    searchInput.placeholder = 'è¯·æœç´¢';
                }
                
                // èšç„¦æœç´¢æ¡†
                searchInput.focus();
            });
        });

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-engine-selector')) {
                engineDropdown.style.display = 'none';
            }
        });

        // å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', (e) => {
            if (e.altKey) {
                const options = document.querySelectorAll('.search-engine-option');
                const index = parseInt(e.key) - 1;
                if (index >= 0 && index < options.length) {
                    const option = options[index];
                    currentEngine = option.dataset.engine;
                    currentEngineIcon.src = option.dataset.icon;
                    engineDropdown.classList.remove('show');
                    e.preventDefault();
                }
            }
            
            // æŒ‰ä¸‹Escé”®å¯æ¸…é™¤æœç´¢æ¡†å†…å®¹
            if (e.key === 'Escape') {
                const searchInput = document.querySelector('.search-input');
                searchInput.value = '';
                searchInput.focus();
            }
            
            // æŒ‰ä¸‹/é”®å¯ä»¥å¿«é€Ÿæ¿€æ´»æœç´¢
            if (e.key === '/' && !document.querySelector('.search-container').classList.contains('active')) {
                e.preventDefault();
                document.querySelector('.search-container').classList.add('active');
                body.classList.add('search-active');
                setTimeout(() => document.querySelector('.search-input').focus(), 300);
            }
        });

        // ä¿®æ”¹æœç´¢å¤„ç†å‡½æ•°
        async function performSearch(query) {
            if (!query.trim()) return;

            switch (currentEngine) {
                case 'bing':
                    window.location.href = `https://cn.bing.com/search?q=${encodeURIComponent(query)}&form=QBLH`;
                    break;
                case 'baidu':
                    window.location.href = `https://www.baidu.com/s?wd=${encodeURIComponent(query)}`;
                    break;
                case 'google':
                    window.location.href = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
                    break;
                case 'ai':
                    // ä½¿ç”¨åŸæœ‰çš„ AI æœç´¢é€»è¾‘
                    try {
                        const searchAPI = new SearchAPI();
                        const searchContainer = document.querySelector('.search-container');
                        const resultsContainer = document.querySelector('.results-container');
                        const initialContent = document.querySelector('.time, .quote-card');
                        
                        // ç¡®ä¿èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ
                        body.classList.add('search-active');
                        
                        // 1. æ·¡å‡ºèµ·å§‹é¡µå†…å®¹
                        initialContent.style.transition = 'opacity 0.3s ease';
                        initialContent.style.opacity = '0';
                        searchContainer.style.transition = 'all 0.6s cubic-bezier(0.19, 1, 0.22, 1)';
                        searchContainer.style.transform = 'translateY(-30px)';
                        searchContainer.style.opacity = '0';
                        
                        // 2. æ˜¾ç¤ºç»“æœé¡µå®¹å™¨
                        resultsContainer.style.display = 'block';
                        
                        // 3. å¼€å§‹ç»“æœé¡µåŠ¨ç”»
                        requestAnimationFrame(() => {
                            resultsContainer.classList.add('visible');
                            
                            // å»¶è¿Ÿæ˜¾ç¤ºæœç´¢ç»“æœåˆ—
                            setTimeout(() => {
                                document.querySelector('.web-results-column').classList.add('visible');
                                document.querySelector('.ai-results-column').classList.add('visible');
                            }, 300);
                        });

                        // 4. è®¾ç½®æœç´¢æ¡†å€¼
                        document.querySelector('.results-search-input').value = query;
                        
                        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                        const webResults = document.querySelector('.web-results');
                        const aiMessages = document.querySelector('.ai-messages');
                        
                        webResults.innerHTML = `
                            <div class="loading-container">
                                <div class="loading-circle"></div>
                                <p>æœç´¢ä¸­...</p>
                            </div>
                        `;
                        
                        aiMessages.innerHTML = `
                            <div class="loading-container">
                                <div class="loading-circle"></div>
                                <p>AI æ­£åœ¨æ€è€ƒä¸­...</p>
                            </div>
                        `;

                        // è°ƒç”¨æœç´¢ API
                        searchAPI.getAIResponse(
                            query,
                            displayWebResults,
                            displayAIContent,
                            async (finalContent) => {
                                try {
                                    // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                                    displayMindMapLoading();
                                    
                                    // ç­‰å¾… AI å›ç­”å®Œæˆ
                                    await new Promise(resolve => {
                                        const checkComplete = () => {
                                            const messageDiv = document.querySelector('.ai-message');
                                            if (messageDiv?.dataset.complete === 'true') {
                                                resolve();
                                            } else {
                                                setTimeout(checkComplete, 100);
                                            }
                                        };
                                        checkComplete();
                                    });
                                    
                                    // ç”Ÿæˆæ€ç»´å¯¼å›¾
                                    const mindMapUrl = await searchAPI.generateMindMap(finalContent);
                                    if (mindMapUrl) {
                                        displayMindMap(mindMapUrl);
                                    } else {
                                        const loadingMindMap = document.querySelector('.mind-map.loading');
                                        if (loadingMindMap) {
                                            clearInterval(Number(loadingMindMap.dataset.animationInterval));
                                            loadingMindMap.remove();
                                        }
                                    }
                                } catch (error) {
                                    console.error('æ€ç»´å¯¼å›¾ç”Ÿæˆå¤±è´¥:', error);
                                    const loadingMindMap = document.querySelector('.mind-map.loading');
                                    if (loadingMindMap) {
                                        clearInterval(Number(loadingMindMap.dataset.animationInterval));
                                        loadingMindMap.remove();
                                    }
                                }
                            }
                        );
                    } catch (error) {
                        console.error('æœç´¢å¤±è´¥:', error);
                        displayError();
                    }
                    break;
            }
        }

        // ä¿®æ”¹ displayAIContent å‡½æ•°ï¼Œæ·»åŠ å®Œæˆæ ‡è®°
        function displayAIContent(content, images = null) {
            const aiMessages = document.querySelector('.ai-messages');
            
            // å¦‚æœå†…å®¹ä¸ºç©ºï¼Œä¸æ›´æ–°æ˜¾ç¤º
            if (!content.trim()) return;
            
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ˜¾ç¤ºå†…å®¹ï¼Œæ¸…é™¤åŠ è½½çŠ¶æ€
            if (aiMessages.querySelector('.loading-container')) {
                aiMessages.innerHTML = '<div class="ai-message markdown-body"></div>';
            }
            
            const messageDiv = aiMessages.querySelector('.ai-message');
            if (messageDiv) {
                const processedContent = content.replace(
                    /ã€(\d+)â€ sourceã€‘/g, 
                    '<sup class="reference-mark" title="å‚è€ƒèµ„æ–™æ¥æº">[$1]</sup>'
                );
                
                messageDiv.innerHTML = marked.parse(processedContent);
                
                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                if (!messageDiv.classList.contains('visible')) {
                    requestAnimationFrame(() => {
                        messageDiv.classList.add('visible');
                        // æ ‡è®° AI å›ç­”å·²å®Œæˆæ˜¾ç¤º
                        messageDiv.dataset.complete = 'true';
                    });
                }
            }
        }

        // ä¿®æ”¹æ€ç»´å¯¼å›¾åŠ è½½çŠ¶æ€æ˜¾ç¤º
        function displayMindMapLoading() {
            const aiMessages = document.querySelector('.ai-messages');
            const existingMindMap = aiMessages.querySelector('.mind-map');
            if (existingMindMap) {
                existingMindMap.remove();
            }

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'mind-map loading';
            loadingDiv.innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">
                        <p class="loading-title">æ­£åœ¨ç”Ÿæˆæ€ç»´å¯¼å›¾</p>
                        <p class="loading-dots">...</p>
                    </div>
                </div>
            `;
            aiMessages.appendChild(loadingDiv);

            // æ·»åŠ åŠ è½½åŠ¨ç”»
            const dots = loadingDiv.querySelector('.loading-dots');
            let count = 0;
            const dotAnimation = setInterval(() => {
                dots.textContent = '.'.repeat((count % 4) || 1);
                count++;
            }, 500);

            // ä¿å­˜åŠ¨ç”»å¼•ç”¨ä»¥ä¾¿åç»­æ¸…é™¤
            loadingDiv.dataset.animationInterval = dotAnimation;

            // ç¡®ä¿åŠ è½½çŠ¶æ€å¯è§
            requestAnimationFrame(() => {
                loadingDiv.style.opacity = '1';
                loadingDiv.style.transform = 'translateY(0)';
            });
        }

        // ä¿®æ”¹æ€ç»´å¯¼å›¾æ˜¾ç¤ºå‡½æ•°
        function displayMindMap(url) {
            const aiMessages = document.querySelector('.ai-messages');
            const messageDiv = aiMessages.querySelector('.ai-message');
            
            // ç¡®ä¿ AI å›ç­”å·²å®Œå…¨æ˜¾ç¤º
            if (!messageDiv || !messageDiv.dataset.complete) {
                setTimeout(() => displayMindMap(url), 100);
                return;
            }
            
            // ç§»é™¤ç°æœ‰çš„åŠ è½½çŠ¶æ€
            const loadingMindMap = aiMessages.querySelector('.mind-map.loading');
            if (loadingMindMap) {
                // æ¸…é™¤åŠ è½½åŠ¨ç”»
                clearInterval(Number(loadingMindMap.dataset.animationInterval));
                loadingMindMap.remove();
            }

            // åˆ›å»ºæ€ç»´å¯¼å›¾å®¹å™¨
            const mindMapDiv = document.createElement('div');
            mindMapDiv.className = 'mind-map';
            mindMapDiv.innerHTML = `
                <h3><i class="fas fa-project-diagram"></i> æ€ç»´å¯¼å›¾</h3>
                <div class="mind-map-content">
                    <img src="${url}" alt="æ€ç»´å¯¼å›¾" class="mind-map-image">
                </div>
            `;
            aiMessages.appendChild(mindMapDiv);

            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            requestAnimationFrame(() => {
                setTimeout(() => {
                    mindMapDiv.classList.add('visible');
                }, 100);
            });
        }

        // ä¿®æ”¹æœç´¢ç»“æœæ˜¾ç¤ºå‡½æ•°
        function displayWebResults(results) {
            const webResults = document.querySelector('.web-results');
            
            // æ¸…é™¤ç°æœ‰ç»“æœ
            webResults.innerHTML = '';
            
            if (!results || results.length === 0) {
                webResults.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <p>æœªæ‰¾åˆ°ç›¸å…³æœç´¢ç»“æœ</p>
                    </div>
                `;
                return;
            }
            
            // éå†ç»“æœï¼Œç¡®ä¿æ¯ä¸ªç»“æœéƒ½æ˜¯é¡¶å±‚å…ƒç´ 
            results.forEach((result, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'search-result';
                resultDiv.dataset.index = index;
                
                resultDiv.innerHTML = `
                    <div class="result-content">
                        <h3>
                            <a href="${result.link}" target="_blank" rel="noopener noreferrer">
                                ${result.title}
                            </a>
                        </h3>
                        <div class="result-url">${formatUrl(result.link)}</div>
                        <p class="result-snippet">${result.content}</p>
                        <div class="result-meta">
                            ${result.time ? `<span class="result-time"><i class="far fa-clock"></i> ${formatTime(result.time)}</span>` : ''}
                            ${result.media ? `<span class="result-source"><i class="far fa-newspaper"></i> ${result.media}</span>` : ''}
                        </div>
                    </div>
                    <div class="icon-links">
                        <a href="https://cn.bing.com/search?q=${encodeURIComponent(result.title)}&form=QBLH" class="icon-link" target="_blank">
                            <img src="https://www.bing.com/favicon.ico" alt="Bing" class="icon">
                        </a>
                    </div>
                `;
                
                webResults.appendChild(resultDiv);
            });

            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            requestAnimationFrame(() => {
                webResults.querySelectorAll('.search-result').forEach((result, index) => {
                    setTimeout(() => {
                        result.classList.add('visible');
                    }, index * 150);
                });
            });
        }

        // æ·»åŠ é”™è¯¯æ˜¾ç¤ºå‡½æ•°
        function displayError() {
            const webResults = document.querySelector('.web-results');
            const aiMessages = document.querySelector('.ai-messages');
            
            webResults.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>æœç´¢ç»“æœè·å–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
                </div>
            `;
            
            aiMessages.innerHTML = `
                <div class="ai-message error">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>AI å“åº”è·å–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
                </div>
            `;
        }

        // æ·»åŠ ç»“æœé¡µé¢çš„æœç´¢åŠŸèƒ½
        const resultsSearchBtn = document.querySelector('.results-search-btn');

        resultsSearchBtn.addEventListener('click', () => {
            const query = resultsSearchInput.value.trim();
            if (query) {
                performSearch(query);
            }
        });

        resultsSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const query = resultsSearchInput.value.trim();
                if (query) {
                    // æ·»åŠ åŠ è½½çŠ¶æ€
                    const searchBtn = document.querySelector('.results-search-btn');
                    searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    searchBtn.disabled = true;

                    // æ‰§è¡Œæœç´¢
                    performSearch(query);

                    // æœç´¢å®Œæˆåæ¢å¤çŠ¶æ€
                    setTimeout(() => {
                        searchBtn.innerHTML = '<i class="fas fa-search"></i>';
                        searchBtn.disabled = false;
                    }, 1000);
                }
            }
        });

        // æ›´æ–°æ—¥æœŸå’Œå¤©æ°”
        updateDate();
        getWeather();
        
        // æ˜¾ç¤ºå¿«é€Ÿé“¾æ¥
        setTimeout(() => {
            const quickLinks = document.querySelector('.quick-links');
            if (quickLinks) {
                quickLinks.classList.add('visible');
            }
        }, 1500);

        // æ ‡è®°æœç´¢å®¹å™¨ä¸ºå·²åŠ è½½çŠ¶æ€ï¼Œä»¥è§¦å‘æœç´¢æŒ‰é’®çš„è„‰å†²åŠ¨ç”»
        setTimeout(() => {
            const searchContainer = document.querySelector('.search-container');
            if (searchContainer) {
                searchContainer.classList.add('loaded');
            }
        }, 2000);

        // ä¿®å¤åœ¨è®¾ç½®sugå‡½æ•°å‰window.bingæœªå®šä¹‰çš„é”™è¯¯
        if(!window.bing) window.bing = {};

        // ä¿®æ”¹JSONPå›è°ƒå‡½æ•°ï¼Œä½¿ç”¨SVGå›¾æ ‡
        window.bing.sug = function(data) {
            const suggestionsBox = document.querySelector('.search-suggestions');
            if(!suggestionsBox) return;
            
            if(data && data.AS && data.AS.Results && data.AS.Results[0] && data.AS.Results[0].Suggests) {
                const suggests = data.AS.Results[0].Suggests;
                if(suggests.length > 0) {
                    // åªæ˜¾ç¤ºå‰3ä¸ªæœç´¢å»ºè®®
                    const limitedSuggests = suggests.slice(0, 3);
                    
                    // å®šä¹‰æœç´¢SVGå›¾æ ‡
                    const searchSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="suggestion-icon">
                        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>`;
                    
                    suggestionsBox.innerHTML = limitedSuggests.map((item, index) => {
                        // é™åˆ¶æ–‡æœ¬é•¿åº¦ä¸º15ä¸ªå­—ç¬¦
                        const limitedText = item.Txt.length > 15 ? 
                            item.Txt.substring(0, 14) + '...' : 
                            item.Txt;
                        
                        return `
                            <div class="search-suggestion-item" data-index="${index}" data-query="${item.Txt}">
                                ${searchSvg}
                                <span>${limitedText}</span>
                            </div>
                        `;
                    }).join('');
                    
                    // ä½¿ç”¨æ›´å¹³æ»‘çš„æ˜¾ç¤ºæ–¹å¼
                    suggestionsBox.style.display = 'none';
                    setTimeout(() => {
                        suggestionsBox.style.display = 'flex';
                        // æ·»åŠ åŠ¨ç”»ç±»
                        suggestionsBox.classList.add('animate-in');
                        setTimeout(() => suggestionsBox.classList.remove('animate-in'), 300);
                    }, 10);
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    document.querySelectorAll('.search-suggestion-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const query = this.getAttribute('data-query');
                            document.querySelector('.search-input').value = query;
                            localStorage.setItem('searchCompleted', 'true');
                            performSearch(query);
                            suggestionsBox.style.display = 'none';
                        });
                    });
                } else {
                    suggestionsBox.style.display = 'none';
                }
            } else {
                suggestionsBox.style.display = 'none';
            }
        };

        // æ·»åŠ é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // ä¿®æ”¹æœç´¢è®°å¿†åŠŸèƒ½éƒ¨åˆ†
        function setupSearchSuggestions() {
            const searchInput = document.querySelector('.search-input');
            const searchContainer = document.querySelector('.search-container');
            
            // åˆ›å»ºæœç´¢å»ºè®®å®¹å™¨
            if(!document.querySelector('.search-suggestions')) {
                const suggestionsBox = document.createElement('div');
                suggestionsBox.className = 'search-suggestions';
                searchContainer.appendChild(suggestionsBox);
            }
            
            // åªåœ¨æœªå®Œæˆæœç´¢æ—¶æ¢å¤ä¸Šæ¬¡å†…å®¹
            const searchCompleted = localStorage.getItem('searchCompleted') === 'true';
            const savedQuery = localStorage.getItem('lastSearchQuery');
            
            // å¦‚æœæœªå®Œæˆæœç´¢ä¸”æœ‰ä¿å­˜çš„å†…å®¹ï¼Œæ‰æ¢å¤è¾“å…¥
            if (savedQuery && !searchCompleted) {
                searchInput.value = savedQuery;
            } else {
                // æ¸…é™¤ä¹‹å‰ä¿å­˜çš„å†…å®¹
                localStorage.removeItem('lastSearchQuery');
                localStorage.removeItem('searchCompleted');
            }
            
            // ç›‘å¬è¾“å…¥äº‹ä»¶å¹¶ä¿å­˜è¾“å…¥å†…å®¹
            searchInput.addEventListener('input', function() {
                // ä¿å­˜å½“å‰è¾“å…¥å†…å®¹ï¼Œå¹¶æ ‡è®°ä¸ºæœªå®Œæˆæœç´¢
                localStorage.setItem('lastSearchQuery', this.value);
                localStorage.setItem('searchCompleted', 'false');
                
                // å¤„ç†æœç´¢è”æƒ³...
                const query = this.value.trim();
                if (query.length < 1) {
                    document.querySelector('.search-suggestions').style.display = 'none';
                    return;
                }
                
                // è§¦å‘æœç´¢è”æƒ³
                fetchSuggestions(query);
            });
            
            // æŠ½ç¦»JSONPè¯·æ±‚é€»è¾‘ä¸ºç‹¬ç«‹å‡½æ•°
            const fetchSuggestions = debounce(function(query) {
                // åˆ›å»ºJSONPè¯·æ±‚
                const script = document.createElement('script');
                script.src = `https://api.bing.com/qsonhs.aspx?type=cb&q=${encodeURIComponent(query)}&cb=window.bing.sug`;
                document.body.appendChild(script);
                
                // æ¸…ç†JSONPè„šæœ¬æ ‡ç­¾
                script.onload = function() {
                    document.body.removeChild(script);
                };
            }, 400);
            
            // ä¿®æ”¹æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼Œæ ‡è®°æœç´¢å·²å®Œæˆ
            document.querySelector('.search-btn').addEventListener('click', function() {
                localStorage.setItem('searchCompleted', 'true');
            });
            
            // åŒæ ·ä¿®æ”¹é”®ç›˜Enteré”®æœç´¢äº‹ä»¶
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    localStorage.setItem('searchCompleted', 'true');
                    // åŸæœ‰æœç´¢ä»£ç ...
                }
            });
            
            // åŒæ ·ä¿®æ”¹æœç´¢è”æƒ³é¡¹ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.search-suggestion-item').forEach(item => {
                item.addEventListener('click', function() {
                    const query = this.getAttribute('data-query');
                    document.querySelector('.search-input').value = query;
                    localStorage.setItem('searchCompleted', 'true');
                    performSearch(query);
                    suggestionsBox.style.display = 'none';
                });
            });

            // ç›‘å¬æœç´¢æ¡†çŠ¶æ€å˜åŒ–
            document.addEventListener('click', function(e) {
                // è·å–æœç´¢å®¹å™¨å’Œå»ºè®®æ¡†
                const searchContainer = document.querySelector('.search-container');
                const suggestionsBox = document.querySelector('.search-suggestions');
                
                // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯æœç´¢å®¹å™¨å†…çš„å…ƒç´ ï¼Œä¸”æœç´¢å®¹å™¨ä¸å†å¤„äºæ¿€æ´»çŠ¶æ€
                if (!e.target.closest('.search-container') || !searchContainer.classList.contains('active')) {
                    // éšè—æœç´¢è”æƒ³
                    if (suggestionsBox) {
                        suggestionsBox.style.display = 'none';
                    }
                }
            });
        }

        // æ·»åŠ æœç´¢è”æƒ³åˆå§‹åŒ–
        setupSearchSuggestions();
    });
    </script>
</body>
</html>